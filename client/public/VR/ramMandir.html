<!doctype html>
<html>
  <head>
    <title>Ram-Mandir VR Experience</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- Vapi integration -->
    <script type="module">
      import { initializeWakeWord } from "./index.js";
      window.initializeWakeWord = initializeWakeWord;
    </script>

    <script>
      const MONUMENT_POS = { x: 0, z: -50 };
      const MONUMENT_RADIUS = 20; // approx Ram-Mandir footprint

      // 1. WALK CONTROLS (Same as before)
      AFRAME.registerComponent("walk-controls", {
        schema: {
          speed: { type: "number", default: 10 },
          threshold: { type: "number", default: -0.25 },
        },
        tick: function (time, timeDelta) {
          var camera = this.el.sceneEl.camera;
          if (!camera) return;
          var direction = new THREE.Vector3();
          camera.getWorldDirection(direction);

          if (direction.y < this.data.threshold) {
            var cursor = document.querySelector("#my-cursor");
            if (cursor) cursor.setAttribute("material", "color", "#00FF00");
            var rig = this.el;
            var pos = rig.getAttribute("position");
            var step = (this.data.speed * timeDelta) / 1000;
            pos.x += direction.x * step;
            pos.z += direction.z * step;
            rig.setAttribute("position", pos);
          } else {
            var cursor = document.querySelector("#my-cursor");
            if (cursor) cursor.setAttribute("material", "color", "white");
          }
        },
      });

      setTimeout(() => {
        const instEl = document.querySelector("#vr-instructions");
        if (instEl) instEl.setAttribute("visible", false);
      }, 7000);

      // 2. ONE-TAP START (Audio + Enter VR)
      AFRAME.registerComponent("start-experience", {
        init: function () {
          // We bind this to the specific #overlay element, not the whole body
          // so clicking around later doesn't re-trigger it.
          var overlay = document.querySelector("#overlay");
          var scene = this.el.sceneEl;

          overlay.addEventListener("click", function () {
            // A. Start Audio
            var sound = document.querySelector("#ambient-sound");
            if (sound) sound.components.sound.playSound();

            // B. Start Listening for Wake Word
            if (window.initializeWakeWord) {
              var startBtn = document.querySelector("#start-btn");
              if (startBtn)
                startBtn.innerText = "Listening for 'Hey Nimbus'...";
              window.initializeWakeWord();
            }

            // C. Enter VR Mode Immediately
            scene.enterVR();

            // C. Hide Overlay
            overlay.style.display = "none";
          });
        },
      });

      AFRAME.registerComponent("modify-materials", {
        init: function () {
          this.el.addEventListener("model-loaded", () => {
            const obj = this.el.getObject3D("mesh");
            if (obj) {
              // Load a texture to apply to the materials
              const textureLoader = new THREE.TextureLoader();
              // Using the existing grass texture as a placeholder if needed,
              // ideally you'd have a specific texture for the temple.
              const templeTexture = textureLoader.load("./assets/grass1.jpg");
              templeTexture.wrapS = THREE.RepeatWrapping;
              templeTexture.wrapT = THREE.RepeatWrapping;
              templeTexture.repeat.set(5, 5);

              obj.traverse((node) => {
                if (node.isMesh) {
                  // Enable shadows for each mesh
                  node.castShadow = true;
                  node.receiveShadow = true;

                  if (node.material) {
                    node.material.metalness = 0.2;
                    node.material.roughness = 0.8;

                    // Apply texture if the material doesn't already have a specific map
                    // and if you want to force a texture.
                    // If the GLB already has textures, this might overwrite them if not careful.
                    // For now, we only apply if there's no map to avoid breaking existing textures.
                    if (!node.material.map) {
                      node.material.map = templeTexture;
                      node.material.needsUpdate = true;
                    }
                  }
                }
              });
            }
          });
        },
      });

      AFRAME.registerComponent("auto-recenter", {
        schema: {
          resetAngle: { type: "number", default: -0.75 },
          holdTime: { type: "number", default: 2500 },
        },

        init: function () {
          this.downStart = null;
        },

        tick: function (time) {
          const camera = this.el.sceneEl.camera;
          if (!camera) return;

          const dir = new THREE.Vector3();
          camera.getWorldDirection(dir);

          if (dir.y < this.data.resetAngle) {
            if (!this.downStart) {
              this.downStart = time;
              return;
            }

            if (time - this.downStart > this.data.holdTime) {
              this.el.setAttribute("position", { x: 0, y: 1.6, z: 0 });
              this.downStart = null;
            }
          } else {
            this.downStart = null;
          }
        },
      });

      AFRAME.registerComponent("tree-spawner", {
        schema: {
          count: { type: "int", default: 30 },
          radius: { type: "number", default: 70 }, // spread area
          minDistance: { type: "number", default: 25 }, // monument se door
        },

        init: function () {
          const scene = this.el.sceneEl;

          for (let i = 0; i < this.data.count; i++) {
            const tree = document.createElement("a-entity");
            tree.setAttribute("gltf-model", "#tree");

            // Random XZ
            let x, z, dist;
            do {
              x = (Math.random() - 0.5) * this.data.radius * 2;
              z = (Math.random() - 0.5) * this.data.radius * 2;
              dist = Math.sqrt(
                Math.pow(x - MONUMENT_POS.x, 2) +
                  Math.pow(z - MONUMENT_POS.z, 2),
              );
            } while (dist < this.data.minDistance); // monument ke paas mat jao

            tree.setAttribute("position", `${x} 0 ${z}`);
            tree.setAttribute("scale", "2 2 2");
            tree.setAttribute("material", {
              shader: "standard",
              metalness: 0,
              roughness: 1,
            });

            // Thoda rotation variation (natural look)
            tree.setAttribute("rotation", `0 ${Math.random() * 360} 0`);

            scene.appendChild(tree);
          }
        },
      });
      const greenTint = 0.8 + Math.random() * 0.2;
      tree.setAttribute(
        "material",
        `shader: standard; metalness: 0; roughness: 1; color: rgb(${80}, ${120 * greenTint}, ${80})`,
      );

      const scale = 1.5 + Math.random() * 1.5;
      tree.setAttribute("scale", `${scale} ${scale} ${scale}`);
    </script>

    <style>
      /* Style for the "Start" Screen */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-family: sans-serif;
      }
      #start-btn {
        border: 2px solid white;
        padding: 20px 40px;
        font-size: 24px;
        background: transparent;
        color: white;
        cursor: pointer;
        border-radius: 50px;
        transition: 0.3s;
      }
      #start-btn:active {
        background: white;
        color: black;
      }
    </style>
  </head>

  <body>
    <div id="overlay">
      <h1>Ram-Mandir VR</h1>
      <p>Put on your headset & tap below</p>
      <div id="start-btn">ENTER EXPERIENCE</div>
    </div>

    <a-scene
      start-experience
      vr-mode-ui="enabled: false"
      fog="type: exponential; color: #cfe9f5; density: 0.003"
    >
      <a-assets>
        <a-asset-item
          id="Ram-Mandir"
          src="./3Dmodels/ram_temple.glb"
        ></a-asset-item>
        <img id="grass-texture" src="./assets/grass1.jpg" />
        <img id="sky-texture" src="./assets/sky1.jpg" />
        <audio id="wind-sound" src="./assets/wind.wav" preload="auto"></audio>
      </a-assets>

      <a-sky src="#sky-texture" rotation="0 -130 0"></a-sky>

      <a-entity
        tree-spawner="count: 20; radius: 80; minDistance: 30"
      ></a-entity>

      <a-asset-item id="tree" src="./assets/tree.glb"></a-asset-item>

      <a-entity
        id="ambient-sound"
        sound="src: #wind-sound; loop: true; volume: 1"
      ></a-entity>

      <a-plane
        src="#grass-texture"
        repeat="30 30"
        material="color: #6f8f5a"
        position="0 0 0"
        rotation="-90 0 0"
        width="150"
        height="150"
        shadow="receive: true"
      >
      </a-plane>

      <a-circle
        radius="18"
        rotation="-90 0 0"
        position="0 0.01 -50"
        material="color: #000; opacity: 0.25"
        shadow="receive: true"
      >
      </a-circle>

      <!-- <a-entity light="type: hemisphere; color: #ffffff; groundColor: #444444; intensity: 0.8"></a-entity> -->
      <!-- <a-entity light="type: ambient; intensity: 1.5"></a-entity> -->
      <!-- <a-entity
        light="type: directional; intensity: 1.0; position: -1 1 0; castShadow: true"
      ></a-entity> -->

      <a-entity
        light="type: hemisphere; color: #ffffff; groundColor: #000000; intensity: 1.5"
      ></a-entity>
      <a-entity
        light="type: directional; intensity: 1.5; position: 5 10 20; castShadow: true"
      ></a-entity>

      <!-- High intensity spotlight -->
      <a-entity
        light="type: spot; intensity: 10.0; color: #ffebc2; position: 0 -40 -20; angle: 45; penumbra: 0.8; castShadow: true; target: #temple-model"
      ></a-entity>

      <a-entity
        id="temple-model"
        gltf-model="#Ram-Mandir"
        modify-materials
        position="0 -1 -50"
        scale="10 10 10"
        rotation="0 180 0"
        shadow="cast: true; receive: true"
      ></a-entity>

      <a-entity id="rig" position="0 1.6 0" walk-controls auto-recenter>
        <a-camera>
          <a-entity
            id="my-cursor"
            cursor="fuse: false"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: white; shader: flat; opacity: 0.8"
          ></a-entity>
          <a-text
            id="vr-instructions"
            value="Look DOWN to Walk\n\nSay 'Hello Nimbus'\nfor a virtual tour guide"
            position="0 -0.5 -1"
            align="center"
            width="2.5"
            color="white"
          ></a-text>

          <!-- Floating VR Captions UI -->
          <a-entity
            id="caption-container"
            position="0 -0.35 -1.2"
            visible="false"
          >
            <!-- Background Panel -->
            <a-entity
              geometry="primitive: plane; width: 1.6; height: 0.35"
              material="color: #000000; opacity: 0.6; transparent: true; shader: flat"
              position="0 0 -0.01"
            ></a-entity>
            <!-- Text Content -->
            <a-text
              id="vr-captions"
              value=""
              align="center"
              width="1.5"
              color="#FFFFFF"
              wrap-count="35"
              baseline="center"
            ></a-text>
          </a-entity>
        </a-camera>
      </a-entity>
    </a-scene>

    <script>
      // Listen for AI transcripts from Vapi and update the floating captions
      window.addEventListener("vapi-transcript", (e) => {
        const captionEl = document.querySelector("#vr-captions");
        const containerEl = document.querySelector("#caption-container");
        if (captionEl && containerEl) {
          captionEl.setAttribute("value", e.detail.text);
          containerEl.setAttribute("visible", "true");
          // Optional: clear the caption after 5 seconds of silence
          clearTimeout(window.captionTimeout);
          window.captionTimeout = setTimeout(() => {
            captionEl.setAttribute("value", "");
            containerEl.setAttribute("visible", "false");
          }, 5000);
        }
      });
    </script>
  </body>
</html>
